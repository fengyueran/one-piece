# 开发指南

## 项目架构

One Piece 采用 Monorepo 架构，使用以下技术栈：

- **包管理**: pnpm + workspace
- **构建工具**: Turborepo + tsup
- **版本管理**: Changesets
- **语言**: TypeScript
- **框架**: React (组件库)

## 目录结构

```text
one-piece/
├── packages/              # 可复用的包
│   ├── compass-ui/       # React 组件库 (@xinghunm/compass-ui)
│   ├── compass-hooks/    # React Hooks (@xinghunm/compass-hooks)
│   └── eslint-plugin-fsd-lint/ # ESLint 插件
├── apps/              # 应用
│   ├── docs/          # 文档站点
│   ├── playground/    # 组件演示
│   └── examples/      # 示例应用
├── tools/             # 开发工具
│   ├── build/         # 构建配置
│   ├── eslint-config/ # ESLint 配置
│   └── tsconfig/      # TypeScript 配置
└── docs/              # 项目文档
```

## 开发流程

### 1. 环境准备

```bash
# 安装 pnpm
npm install -g pnpm

# 安装依赖
pnpm install
```

### 2. 开发模式

```bash
# 启动所有包的开发模式
pnpm dev

# 启动特定包的开发模式
pnpm --filter @xinghunm/compass-ui dev
```

### 3. 构建

```bash
# 构建所有包
pnpm build

# 构建特定包
pnpm --filter @xinghunm/compass-ui build
```

### 4. 测试

```bash
# 运行所有测试
pnpm test

# 运行特定包的测试
pnpm --filter @xinghunm/compass-ui test
```

## 添加新包

### 1. 创建包目录

```bash
mkdir packages/new-package
cd packages/new-package
```

### 2. 创建 package.json

```json
{
  "name": "@one-piece/new-package",
  "version": "0.0.0",
  "description": "新包描述",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "files": ["dist"],
  "scripts": {
    "build": "tsup src/index.ts --format cjs,esm --dts",
    "dev": "tsup src/index.ts --format cjs,esm --dts --watch",
    "lint": "eslint src --ext .ts,.tsx",
    "test": "jest",
    "clean": "rm -rf dist"
  },
  "devDependencies": {
    "tsup": "^7.2.0",
    "typescript": "^5.2.2"
  },
  "publishConfig": {
    "access": "public"
  }
}
```

### 3. 创建源码

```bash
mkdir src
echo "export * from './main'" > src/index.ts
```

## 发布流程

### 1. 创建变更集 (Changeset)

当开发完成并准备发布时，需要创建变更集来描述本次更新内容。

```bash
pnpm changeset
```

**操作指南（多包场景）：**

1.  运行命令后，CLI 会列出所有变更过的包。
2.  **推荐做法**：如果涉及多个包的变更（例如同时修改了 `compass-ui` 和 `compass-hooks`），建议**分多次运行**该命令。
    - **第一次运行**：只勾选 `compass-ui`，填写 UI 相关的变更描述（如：新增 Form 组件）。
    - **第二次运行**：只勾选 `compass-hooks`，填写 Hooks 相关的变更描述（如：新增 useAsync Hook）。
3.  **好处**：这样做可以确保生成的 `CHANGELOG.md` 清晰、独立，不会将 UI 的变更日志混入 Hooks 的日志中，反之亦然。

### 2. 提交变更集 (Commit Changesets)

生成完所有 `.changeset/*.md` 文件后，通常需要将其提交到代码仓库。

> **场景说明**：
>
> - **团队协作/CI发布（推荐）**：**必须提交**。这样变更记录可以经过 Code Review，并且 CI 服务器需要读取这些文件来自动发版。
> - **个人本地快速发布**：如果紧接着就要运行版本升级命令，可以选择**不提交**这些中间文件，直接进入下一步。但这意味着变更记录不会留存在 Git 历史中（只存在于最终的 CHANGELOG）。

```bash
git add .changeset
git commit -m "chore: add changesets"
```

### 3. 版本升级 (Version)

此步骤会消耗所有的变更集文件（`.changeset/*.md`），更新包版本并生成 CHANGELOG。

```bash
pnpm version-packages
```

> **说明**：此命令是**全局执行**的。它会自动扫描 `.changeset` 目录下的所有文件，一次性计算并更新所有受影响包的版本号。
>
> - 自动处理依赖关系：如果 `compass-ui` 依赖了 `compass-hooks`，当 `compass-hooks` 升级时，`compass-ui` 的依赖版本也会自动更新。
> - 自动生成文档：会分别更新 `packages/compass-ui/CHANGELOG.md` 和 `packages/compass-hooks/CHANGELOG.md`。

**注意**：版本升级命令会修改 `package.json` 和 `CHANGELOG.md` 并删除 `.changeset` 文件，执行完后需要再次提交代码。

```bash
git add .
git commit -m "chore: release version packages"
```

### 4. 发布 (Publish)

将更新后的包发布到 npm registry。

```bash
pnpm release
```

此命令会遍历所有版本号已更新但尚未发布的包，并将它们统一发布。

## 代码规范

### 命名规范

- **包名**: `@xinghunm/package-name`
- **文件名**: `kebab-case.ts`
- **组件名**: `PascalCase`
- **函数名**: `camelCase`
- **常量名**: `UPPER_SNAKE_CASE`

### 提交规范

使用 Conventional Commits 规范：

```text
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
test: 测试相关
chore: 构建/工具相关
```

## 最佳实践

### 1. 包设计原则

- **单一职责**: 每个包应该有明确的单一职责
- **最小依赖**: 尽量减少外部依赖
- **向后兼容**: API 变更需要考虑向后兼容性

### 2. 代码质量

- 使用 TypeScript 进行类型检查
- 编写单元测试
- 遵循 ESLint 规则
- 添加适当的文档注释

### 3. 性能考虑

- Tree-shaking 友好的导出方式
- 避免不必要的依赖
- 合理的包大小控制
